<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Dashboard &#124; ChoresDone</title>
    <link rel="stylesheet" href="../styles/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap');
    </style>
</head>
<body>
    <div class="navbar">
        <div id="logo" class="logo">ChoresDone</div>
        <div id="numberOfChoresDone" class="chores-done heading">0</div>
    </div>

    <div class="bigboy-container">
        <div class="dashboard-header">
            <h1 class="heading">Hello <span id="name">[name]</span>,</h1>
            <h2 id="message" class="subheading">[message]</h2>
        </div>
    </div>

    <div class="dashboard bigboy-container">
        <div class="button-container">
            <button id="button_nudge" class="add-people nudge heading">Nudge</button>
            <button id="button_addPeople" class="add-people heading">&#43; Add People</button>
            <button id="button_addChores" class="add-chores heading">&#43; Add Chores</button>
            <button id="button_removeChore" class="add-people heading">Remove Chore</button>
        </div>
    </div>

    <div id="taskTable">
        <table>
        </table>
    </div>
    <script>
        let logo = document.getElementById('logo');
        let choresDone = document.getElementById('numberOfChoresDone');
        let name = document.getElementById('name');
        let message = document.getElementById('message');
        let success = localStorage.getItem("loginSuccess");
        let button_addPeople = document.getElementById('button_addPeople');
        let button_addChores = document.getElementById('button_addChores');
        let button_nudge = document.getElementById('button_nudge');
        let button_removeChore = document.getElementById('button_removeChore');
        let people = [];
        let chores = [];
        let choresDoneCounter = 0;

        if (success === 'true') {
            name.textContent = localStorage.getItem("username");
            getQuote().then(quote => {
                message.textContent = quote;
            });
        }

        async function getQuote () {
            try {
                let response = await fetch('https://dummyjson.com/quotes/random');
                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }
                let quote = await response.json();
                return quote.quote + " - " + quote.author;
            } catch (error) {
                console.log(error);
            }
        }

        let taskTable = document.getElementById('taskTable');

        function buildTable() {
            taskTable.textContent = "";
            //Building table head. It will contain the choreTitles
            let thead = document.createElement('thead');
            let headerRow = document.createElement('tr');
            let emptyCell = document.createElement('th'); //Left corner needs to be empty because the names go there
            emptyCell.className = "emptyCell";
            headerRow.appendChild(emptyCell);
            
            //Adding choreTitle for rowHeader using a for loop
            chores.forEach(chore => {
                let choreTitle = document.createElement('th');
                choreTitle.textContent = chore;
                headerRow.appendChild(choreTitle);
                headerRow.className = 'choreHeadings';
            })
            thead.appendChild(headerRow);
            taskTable.appendChild(thead);

            //Building the table body. It will contain name of the People
            let tbody = document.createElement('tbody');
            tbody.className = 'tbody';
                people.forEach(person => { 
                    let personRow = document.createElement('tr'); // New row for tasks for each person
                    let nameCell = document.createElement('td'); // Name cell that will contain name of person
                    nameCell.className = 'nameCell';
                    nameCell.textContent = person;

                    personRow.appendChild(nameCell); // Append name cell to personRow

                    chores.forEach(chore => { // To make checkboxes for each chore
                    let checkboxCell = document.createElement('td'); // To store the checkbox container
                    let checkboxContainer = document.createElement('div'); // Container that will store 7 checkboxes
                    checkboxCell.className = 'checkboxCell';
                    checkboxContainer.className = 'checkbox-container';

                    for(let i = 0; i < 7; i++) { //Creating 7 checkboxes
                        let checkbox = document.createElement('input');
                        checkbox.className = 'checkbox';
                        checkbox.type = 'checkbox';
                        checkbox.addEventListener('change', () => {
                            //Incrementing and decrementing the Chores done counter
                            if(checkbox.checked) {
                                choresDoneCounter++;
                            } else {
                                choresDoneCounter --;
                            }
                            choresDone.innerText = choresDoneCounter;
                            if(choresDone.innerText == 7) {
                                alert("Wahoo! You're done with a Chore for the week. Great work.")
                            }
                        })
                        checkboxContainer.appendChild(checkbox);
                    }
                    checkboxCell.appendChild(checkboxContainer);
                    personRow.appendChild(checkboxCell);
                })
                let trashCell = document.createElement('td');
                trashCell.style.backgroundColor = '#FFF9F5';
                let trashContainer = document.createElement('div');
                trashCell.className = 'trashCell';
                trashContainer.className = 'trashContainer';
                let trashBox = document.createElement('img');
                trashBox.src = '../images/trash.svg';

                trashCell.addEventListener('click', () => {
                    let storedPeople = JSON.parse(localStorage.getItem("people"));
                    let index = storedPeople.indexOf(person);
                    if (index !== -1) {
                        storedPeople.splice(index, 1);
                        people.splice(index, 1);
                        localStorage.setItem("people", JSON.stringify(storedPeople));
                    }
                    if (people.length === 0) {
                        localStorage.removeItem('chores');
                        location.reload();
                    }

                    personRow.remove();
                });

                trashContainer.appendChild(trashBox);
                trashCell.appendChild(trashContainer);

                personRow.appendChild(trashCell);
                tbody.appendChild(personRow);
            })


            taskTable.appendChild(tbody);
            taskTable.className = "taskTable";
        }

        let addPeople = () => {
            let personName = prompt("Enter the person's username:");
            if (personName) {
                people.push(personName);
                buildTable();
            }
            localStorage.setItem("people", JSON.stringify(people));
        }

        let addChores = () => {
            let choreName = prompt("Enter the task name:");
            if (choreName) {
                chores.push(choreName);
                buildTable();
            }

            localStorage.setItem("chores", JSON.stringify(chores));
        }

        button_addPeople.addEventListener('click', addPeople);
        button_addChores.addEventListener('click', addChores);

        logo.addEventListener('click', () => {
            location.replace('../index.html');
        });

        button_nudge.addEventListener('click', () => {
            let whoToNudge = prompt('Who do you want to nudge? (case-sensitive)');
            try {
                let storedPeople = JSON.parse(localStorage.getItem('people'));
                let index = storedPeople.indexOf(whoToNudge);
                let nudged = false;

                if(index == -1) { //To check if the people array contains the username
                    alert("Person of this username does not exist");
                    throw new Error('The people array does not contain this username');
                } else {
                    prompt("Enter your message:");
                    nudged = true;
                }
                if(nudged = true) {
                    alert(`Successfully nudged ${whoToNudge}!`);
                }
            } catch(error) {
                console.log('Error: ' + error);
            }
        })

        button_removeChore.addEventListener('click', () => {
            let choreToRemove = prompt("Enter chore name to remove (case-sensitive)");
            try {
                let storedChores = JSON.parse(localStorage.getItem('chores'));
                let index = storedChores.indexOf(choreToRemove);
                let choreRemoved = false;

                if(index == -1) {
                    alert('A chore of this name does not exist');
                    throw new Error('The chore array does not contain a chore of this name.');
                } else {
                    chores.splice(index, 1);
                    storedChores.splice(index, 1);
                    localStorage.setItem("chores", JSON.stringify(storedChores));
                    choreRemoved = true;
                }
                if(choreRemoved == true) {
                    location.reload();
                    alert(`The chore ${choreToRemove} has been removed.`);
                }
            } catch(error) {
                console.log(error);
            }
        })

        let retrievedChores = localStorage.getItem("chores");
        let retrievedPeople = localStorage.getItem("people");

        if(retrievedChores) {
            chores = JSON.parse(retrievedChores);
        }

        if(retrievedPeople) {
            people = JSON.parse(retrievedPeople);
        }

        buildTable();
    </script>       
</body>
</html>